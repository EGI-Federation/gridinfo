#!/usr/bin/env python

import ldap
import sys
import getopt
import json
import os

VERSION = '0.45'
conf = {}

def main(argv):
	""" Main function that launches the other functions """
	if 'LCG_GFAL_INFOSYS' in os.environ:
		conf['host'] = os.environ['LCG_GFAL_INFOSYS']

	try:
		opts, args = getopt.getopt(argv, "t:i:c:s:d:l:jhvV", ["type=","interface=","capability=","state=","domain=","list=","json","help","verbose","version","csv","vo=","host="])
	except getopt.GetoptError:
		sys.exit(usage())
	
	parse_options(opts,args)
	validate_conf()
	if 'list' in conf:
		list = list_attr()
		print '\n'.join(list)
		# USE serialize_output() ??????
	else:
		dic = list_services()
		print serialize_output(dic)
	sys.exit()

def parse_options(opts,args):
	""" Puts the options in a configuration dictionnary """
        for opt, arg in opts:
                if opt in ("-h", "--help"):
                        conf['help'] = True
                elif opt in ("-V", "--version"):
                        conf['version'] = True
                elif opt in ("-v", "--verbose"):
                        conf['verbose'] = True
                elif opt == "--csv":
                        conf['csv'] = True
                elif opt in ("-j","--json"):
                        conf['json'] = True
                elif opt == "--host":
                        conf['host'] = arg
                elif opt in ("-l","--list"):
                        conf['list'] = arg
                elif opt == "--vo":
                        conf['vo'] = arg
                elif opt in ("-t","--type"):
                        conf['type'] = arg
                elif opt in ("-i","--interface"):
                        conf['interface'] = arg
                elif opt in ("-c","--capability"):
                        conf['capability'] = arg
                elif opt in ("-s","--state"):
                        conf['state'] = arg
                elif opt in ("-d","--domain"):
                        conf['domain'] = arg
	if len(args) > 0:
		conf['args'] = args
		if 'all' in args:
			conf['args'] = ['url','type','vo','interface','capability','state','domain']
	else:
		conf['args'] = ['url']

def validate_conf():
	""" Prints verbose messages and checks for errors """
	list_attributes = ['type','vo','interface','capability','state','domain']
        if 'help' in conf:
                print usage()
		sys.exit()
        if 'version' in conf:
                print os.path.basename(sys.argv[0]) +' V'+VERSION
		sys.exit()
        if 'verbose' in conf:
                print 'Verbose mode activated.'
        if 'csv' in conf and 'json' in conf:
                sys.exit('Error: choose between csv and json.')
        elif 'csv' in conf:
                if 'verbose' in conf:
                        print 'Output in csv formating'
        elif 'json' in conf:
                if 'verbose' in conf:
                        print 'Output in json formating'
        if 'host' in conf:
                if 'verbose' in conf:
                        print 'The following host will be used:',conf['host']
        else:
                sys.exit(usage())
        if 'list' in conf:
		if conf['list'] not in list_attributes:
			sys.exit('Error: wrong attribute.')
                if 'verbose' in conf:
                        print 'Lists all the published values for the following attribute:',conf['list']
        if 'vo' in conf:
                if 'verbose' in conf:
                        print 'Lists all services for the following VO:',conf['vo']
        if 'type' in conf:
                if 'verbose' in conf:
                        print 'Lists all services for the following type:',conf['type']
	if 'interface' in conf:
		if 'verbose' in conf:
			print 'Lists all services for the following interface:',conf['interface']
        if 'capability' in conf:
                if 'verbose' in conf:
                        print 'Lists all services for the following capability:',conf['capability']
        if 'state' in conf:
                if 'verbose' in conf:
                        print 'Lists all services for the following state:',conf['state']
        if 'domain' in conf:
                if 'verbose' in conf:
                        print 'Lists all services for the following domain:',conf['domain']
	if 'args' in conf:
		for arg in conf['args']:
			if arg not in list_attributes+['url']:
        	                sys.exit('Error: wrong attribute.')
		if 'verbose' in conf:
			print 'The following attributes will be displayed:',' '.join(conf['args'])
	if 'verbose' in conf:
		print

def usage():
	""" Returns the usage message """
	return '''Usage: service-info [options]

    --host		host:port	Specify a host endpoint (<hostname>:<port>). By default the environmental variable LCG_GFAL_INFOSYS will be used.
    -t, --type		type		Lists all services of a specific type
    --vo		VO		Lists all services for a specific VO
    -i, --interface	interface	Lists all services for a specific interface
    -c, --capability	capability	Lists all services for a specific capability
    -s, --state		state		Lists all services for a specific state
    -d, --domain	domain		Lists all services for a specific domain
    -l, --list		attribute	Lists all the published values for an attribute (type, vo)
    --csv				Provides the output in CSV formating
    -j, --json				Provides the output in JSON formating
    -h, --help				Prints this helpful message
    -v, --verbose			Verbose mode
    -V, --version			Version'''

def request(filter=None):
	""" Returns the result of the ldap request with the filter given """	
	try:
		l = ldap.initialize('ldap://'+conf['host'])
		if filter != None:
			result = l.result(l.search('o=glue',ldap.SCOPE_SUBTREE,filter))
		else:
			result = l.result(l.search('o=glue',ldap.SCOPE_SUBTREE))
	except ldap.SERVER_DOWN:
		sys.exit('Error: Can\'t contact the LDAP server. Please check your host.')
	return result[1]

def list_services():
	""" Returns a dictionnary of the filtered results from an ldap request """
	filter = '(&(objectClass=GLUE2Endpoint)'
	if 'interface' in conf:
		filter += '(GLUE2EndpointInterfaceName='+conf['interface']+')'
	if 'capability' in conf:
		filter += '(GLUE2EndpointCapability='+conf['capability']+')'
	if 'state' in conf:
                filter += '(GLUE2EndpointHealthState='+conf['state']+')'
        result = request(filter +')')
	if 'vo' in conf:
		listVO = []
		resultVO = request('(&(objectClass=GLUE2AccessPolicy)(|(GLUE2PolicyRule=ALL)(GLUE2PolicyRule='+conf['vo']+')))')
		for rV in resultVO:
			listVO.append(rV[1]['GLUE2AccessPolicyEndpointForeignKey'][0])
	filterServices = None
	if 'type' in conf:
		filterServices = '(&(objectClass=GLUE2Service)(GLUE2ServiceType='+conf['type']+')'
	if 'domain' in conf:
		if not filterServices:
			filterServices = '(&(objectClass=GLUE2Service)'
		filterServices += '(GLUE2ServiceAdminDomainForeignKey='+conf['domain']+')'
	if filterServices:
		listServices = []
		resultServices = request(filterServices+')')
		for rS in resultServices:
			listServices.append(rS[1]['GLUE2ServiceID'][0])
	dic = {}
	for res in result:
		serviceID = res[1]['GLUE2EndpointServiceForeignKey'][0]
		endpointID = res[1]['GLUE2EndpointID'][0]
		if 'vo' in conf and endpointID not in listVO:
				continue
                if filterServices and serviceID not in listServices:
                                continue
		dic[serviceID] = {}
		if 'url' in conf['args']:
			dic[serviceID]['url'] = res[1]['GLUE2EndpointURL']
		if 'interface' in conf['args']:
			dic[serviceID]['interface'] = res[1]['GLUE2EndpointInterfaceName']
		if 'capability' in conf['args']:
			if 'GLUE2EndpointCapability' in res[1]:
				dic[serviceID]['capability'] = res[1]['GLUE2EndpointCapability']
			else:
				dic[serviceID]['capability'] = [] 
		if 'state' in conf['args']:
			 dic[serviceID]['state'] = res[1]['GLUE2EndpointHealthState']
	if len(dic) == 0:
		sys.exit('Error: No result. Verify search parameters.')
	return dic 

def list_attr():
	""" Returns a list of values for a given attribute """
	if conf['list'] == 'type':
        	oClass = 'Service'
		key = 'ServiceType'
	elif conf['list'] == 'vo':
		oClass = 'Policy'
		key = 'PolicyRule'
	elif conf['list'] == 'interface':
		oClass = 'Endpoint'
		key = 'EndpointInterfaceName'
        elif conf['list'] == 'capability':
                oClass = 'Endpoint'
                key = 'EndpointCapability'
        elif conf['list'] == 'state':
                oClass = 'Endpoint'
                key = 'EndpointHealthState'
        elif conf['list'] == 'domain':
                oClass = 'Service'
                key = 'ServiceAdminDomainForeignKey'
	else:
		sys.exit('Error: wrong attribute.')
	result = request('objectClass=GLUE2'+oClass)
        list=[]
        for r in result:
		if 'GLUE2'+key in r[1]:
			if r[1]['GLUE2'+key][0] not in list:
				list.append(r[1]['GLUE2'+key][0])
		else:
			if 'None' not in list:
				list.append('None')
	list.sort()
	return list

def serialize_output(dic):
        """ Return the output with the wished format """
	if 'csv' in conf:
		list=[]
		for i in dic:
                        list.append(str(dic[i]['url'][0]))
                output = ','.join(list)
        elif 'json' in conf:
                output = json.dumps(dic)
        else:
		list=[]
		for i in dic:
			if 'url' in conf['args']:
				list.append('URL: '+str(dic[i]['url'][0]))
			if 'interface' in conf['args']:
                                list.append('Interface: '+str(dic[i]['interface'][0]))
			if 'state' in conf['args']:
				list.append('State: '+str(dic[i]['state'][0]))
			if 'capability' in conf['args']:
				list.append('Capability: '+','.join(dic[i]['capability']))
			list.append('')
                output = '\n'.join(list)
        return output

if __name__ == "__main__":
    main(sys.argv[1:])
